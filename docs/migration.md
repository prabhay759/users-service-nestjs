# Database Migration

A migration is just a single file with sql queries to update a database schema and apply new changes
to an existing database. TypeORM provides many ways to run database migration and it manages previously
ran migrations for you.

## Pre-requisites

1. Nest CLI
2. Database config
3. Active connection to database

## Database Config

Database configuration is stored at `src/config/database.config.ts`, which provides reasonable defaults
for a local dev environment, taking properties from OS environment variables otherwise. A few notable
configuration settings there include:

1.  `synchronize`: Setting this to `true` means NestJS would try to synchronize the database for you,
    based on the entities defined inside the application.

        ❗It's not recommended to set this to `true` in production.

2.  `entities`: Migration command needs details of database entities. The current configuration includes all
    the files ending with `entity.js`.
3.  `migrations`: This is where NestJS generate command creates your new database scripts. It uses the same path
    to apply migration.
4.  `cli`: This option's used to configure Nest CLI configuration for running the database migration scripts.

## Generating migration scripts

NestJS offers CLI to generate the database scripts. It checks the existing entities and compares it
with migrations scripts and generates a new one if found any changes. To generate a new database scripts
locally run below command.

```sh
npm run typeorm:migration:generate -- Entity Name i.e. npm run typeorm:migration:generate -- Customer
```

`Note`: Scripts generated by CLI not always in good shape, hence feel free to format and make the necessary
changes as per your need. It is advised to review the scripts before applying it.

## Running the migration scripts

Migration scripts run in background on application start. Application gets terminated if migrations fail.

In order to run the migration scripts from a console, do:

```sh
npm run typeorm:migration:run
```

## Reverting the migration

Executing the below command will revert the latest scripts applied to the database. Running the same
command multiple times would result in reverting all changes applied to the database.

❗Avoid running the revert command on production as it would wipe out the history.

```sh
npm run typeorm:migration:revert
```

The recommended approach would be creating a new script, which would revert old changes, and let it run on
application start.

## Testing Migration scripts

It's good practice to test migration scripts against a local database before applying it on DEV, QA, or PROD
environments. To spawn a local database, run

```sh
npm run start:local:db
```
